# 更新日志

## 2025-12-18 - 修复和增强

### 🐛 Bug 修复

1. **修复第一张图片不显示的问题**
   - 问题: 拖入单张图片或文件夹时,第一张图片无法显示
   - 原因: `watch` 和 `loadImage` 的时序问题,DOM 可能还未准备好
   - 解决方案:
     - 移除了 `watch(currentImage)`,改为在 `loadImage` 中直接调用 `initViewer()`
     - 使用 `nextTick()` 确保 DOM 更新后再初始化查看器
     - 将 `loadImage` 改为异步函数,确保初始化完成

2. **修复 OpenSeadragon 实例未正确销毁的问题**
   - 在销毁旧实例后将 `viewer` 设置为 `null`
   - 避免内存泄漏和潜在的冲突

### ✨ 新功能

1. **支持 HEIC/HEIF 格式图片**
   - 安装了 `heic2any` 库
   - 自动检测 HEIC/HEIF 格式文件
   - 自动转换为 JPEG 格式 (质量 90%)
   - 转换后的文件名自动更改为 `.jpg` 扩展名

2. **加载状态提示**
   - 添加了加载指示器
   - 在处理图片(特别是转换 HEIC 格式)时显示
   - 使用 DaisyUI 的 loading spinner 组件

### 🔧 技术改进

1. **异步处理优化**
   - 所有图片处理都是异步的
   - 使用 `async/await` 确保正确的执行顺序
   - 使用 `nextTick()` 确保 Vue 的响应式更新完成

2. **错误处理**
   - 添加了 HEIC 转换失败的错误处理
   - 转换失败时在控制台输出错误信息
   - 不会因为单个文件转换失败而中断整个流程

### 📝 用户界面更新

1. **更新了拖拽区域提示文本**
   - 明确说明支持 HEIC/HEIF 格式
   - 更友好的用户提示

2. **添加了加载动画**
   - 使用 DaisyUI 的 loading spinner
   - 显示"正在处理图片..."提示

## 支持的图片格式

- ✅ JPEG/JPG
- ✅ PNG
- ✅ GIF
- ✅ WebP
- ✅ BMP
- ✅ SVG
- ✅ HEIC/HEIF (自动转换为 JPEG)
- ✅ 其他浏览器原生支持的图片格式

## 测试建议

1. **测试单张图片**:
   - 拖入一张 JPG 图片,应该立即显示
   - 拖入一张 HEIC 图片,应该显示加载动画后转换并显示

2. **测试文件夹**:
   - 拖入包含多张图片的文件夹
   - 第一张图片应该立即显示
   - 使用左右箭头键或按钮切换图片

3. **测试混合格式**:
   - 拖入包含 JPG、PNG、HEIC 等多种格式的文件夹
   - 所有格式都应该正确显示

4. **测试键盘快捷键**:
   - `←` 上一张
   - `→` 下一张
   - `Esc` 关闭查看器

